<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>sbotto.io - Bacheca P2P</title>
<style>
body{
  font-family:"Arial Rounded MT Bold", Arial, sans-serif;
  background:#f3efe6; margin:0; padding:20px;
}
.container{max-width:1200px; margin:auto; text-align:center;}
h1{margin-bottom:10px;}

#board{
  position:relative; width:100%; min-height:800px;
  background:#fafafa; border:2px dashed #ccc; overflow:hidden;
  margin-top:20px;
}

.note{
  width:130px; height:130px; padding:14px 10px;
  border-radius:2px; position:absolute;
  display:flex; justify-content:center; align-items:center;
  font-weight:bold;
  box-shadow:-3px 3px 6px rgba(0,0,0,.25);
}

/* Colori */
.yellow{background:linear-gradient(135deg,#fff59d,#fdd835);}
.blue  {background:linear-gradient(135deg,#90caf9,#42a5f5);}
.green {background:linear-gradient(135deg,#a5d6a7,#66bb6a);}
.pink  {background:linear-gradient(135deg,#f48fb1,#ec407a);}
.orange{background:linear-gradient(135deg,#ffcc80,#fb8c00);}
.black {background:linear-gradient(135deg,#000,#333); color:#fff;}
.red   {background:linear-gradient(135deg,#ff8a80,#e53935); color:#fff;}
.lilla {background:linear-gradient(135deg,#ce93d8,#8e24aa); color:#fff;}
.fucsia{background:linear-gradient(135deg,#f06292,#ad1457); color:#fff;}
.ghost {
  background: rgba(255, 255, 255, 0.05);
  color: rgba(0,0,0,0.3);
  border: 1px dashed rgba(0,0,0,0.15);
  backdrop-filter: blur(2px);
}
.madama {
  background:linear-gradient(135deg,#ff1744,#b71c1c);
  color:#fff;
  animation: lampeggio 0.8s infinite alternate;
}
@keyframes lampeggio {
  from { box-shadow:0 0 5px #ff1744, 0 0 10px #ff1744; }
  to   { box-shadow:0 0 20px #ff1744, 0 0 40px #ff1744; }
}

/* contatore */
#counterBox {
  margin-top:10px; font-size:14px; color:#444;
}

/* pulsante reset */
#resetBtn {
  margin-top:20px;
  padding:8px 14px;
  background:#c62828;
  color:#fff;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
#resetBtn:hover { background:#b71c1c; }
</style>
</head>
<body>
  <div class="container">
    <h1>üìå Sbotto.io</h1>
    <textarea id="noteInput" placeholder="Scrivi qui il tuo post-it (max 40 caratteri)..."></textarea><br>
    <button onclick="aggiungiNota()">Pubblica Post-it</button>
    <div id="counterBox">üìù Totale post-it: 0</div>

    <!-- Tasto reset -->
    <button id="resetBtn" onclick="resetTutto()">üîÑ Reset Totale</button>

    <div id="board"></div>
  </div>

  <!-- GUN -->
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script>
  const gun = Gun({
    peers:[
      "https://gun.database.eco/gun",
      "https://peer.wallie.io/gun",
      "https://gun-altcoins.herokuapp.com/gun"
    ]
  });

  const notesDB = gun.get("p2p-postit");
  const counterDB = gun.get("p2p-postit-counter");
  let store = {};
  let totalCounter = 0;

  function render(){
    const board = document.getElementById("board");
    board.innerHTML="";
    Object.values(store).forEach(n=>{
      if(!n || n.deleted) return;
      const div = document.createElement("div");
      div.id = "note_"+n.id;
      div.className = `note ${n.color}`;
      div.style.color = n.textColor || "#000";
      div.style.left = (n.x||0)+"px";
      div.style.top  = (n.y||0)+"px";
      div.textContent = n.text;
      board.appendChild(div);
    });
  }

  function aggiungiNota(){
    let text = document.getElementById("noteInput").value.trim();
    if(!text) return alert("Scrivi qualcosa!");
    if(text.length > 40) text = text.substring(0,37)+"...";
    const board = document.getElementById("board");
    const maxX = Math.max(0, board.clientWidth-150);
    const maxY = Math.max(0, board.clientHeight-150);

    let note = {
      id: Gun.text.random(16),
      text,
      date: Date.now(),
      x: Math.floor(Math.random()*maxX),
      y: Math.floor(Math.random()*maxY),
      color:"yellow",
      textColor:"#000"
    };

    notesDB.get(note.id).put(note);

    // incrementa contatore globale
    counterDB.get("total").once(val=>{
      const current = val || 0;
      counterDB.get("total").put(current + 1);
    });

    document.getElementById("noteInput").value="";
  }

  // reset totale: cancella post-it e azzera contatore
  function resetTutto(){
    if(!confirm("‚ö†Ô∏è Sei sicuro di voler cancellare tutto?")) return;

    notesDB.map().once((n,id)=>{
      notesDB.get(id).put(null);
    });

    counterDB.get("total").put(0);

    localStorage.removeItem("sbotto-notes");
    localStorage.removeItem("p2p-postit-counter");

    store = {};
    render();
    document.getElementById("counterBox").textContent = "üìù Totale post-it: 0";
  }

  // Ascolta database
  notesDB.map().on((n,id)=>{
    if(!n || !n.id || n.deleted){ delete store[id]; }
    else { store[id]=Object.assign(store[id]||{}, n); }
    render();
  });

  // Ascolta contatore
  counterDB.get("total").on(val=>{
    totalCounter = val || 0;
    document.getElementById("counterBox").textContent = "üìù Totale post-it: " + totalCounter;
  });
  </script>
</body>
</html>
