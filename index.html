<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>sbotto.io - Bacheca P2P (per sempre)</title>
<style>
body{
  font-family:"Arial Rounded MT Bold", Arial, sans-serif;
  background:#f3efe6; margin:0; padding:20px;
}
.container{max-width:1200px; margin:auto; text-align:center;}
h1{margin-bottom:10px;}

/* Box introduttivo */
.intro {
  max-width: 800px;
  margin: 10px auto 20px auto;
  padding: 15px 20px;
  border-radius: 8px;
  background: #fff3cd;
  color: #856404;
  font-weight: bold;
  font-size: 15px;
  box-shadow: 0 0 8px rgba(0,0,0,0.1);
  position: relative;
}
.info-icon { margin-left: 10px; cursor: pointer; font-size: 18px; }

/* Popup regolamento */
#regolamentoBox {
  display: none;
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  max-width: 500px;
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
  z-index: 3000;
  text-align: left;
  line-height: 1.5;
}
#regolamentoBox h2 { margin-top: 0; }
#regolamentoBox .close {
  position: absolute;
  top: 10px; right: 15px;
  cursor: pointer; font-size: 20px;
}
#overlay {
  display: none; position: fixed; top:0; left:0;
  width:100%; height:100%; background: rgba(0,0,0,0.5);
  z-index: 2000;
}

textarea{
  width:100%; height:80px; padding:10px; border-radius:5px;
  border:1px solid #ccc; resize:none; font-size:14px;
}
.controls{
  margin:10px 0; display:flex; flex-wrap:wrap;
  justify-content:center; gap:15px;
}
.controls label{font-weight:bold; margin-right:5px;}
button{
  margin-top:10px; padding:10px 20px; border:none; border-radius:5px;
  background:#ff7043; color:#fff; cursor:pointer; font-weight:bold;
}
button:hover{background:#f4511e;}

#board{
  position:relative; width:100%; min-height:800px;
  background:#fafafa; border:2px dashed #ccc; overflow:hidden;
}

/* Post-it base */
.note{
  width:130px; height:130px;
  padding:14px 10px 10px 10px;
  border-radius:2px;
  position:absolute; overflow:hidden;
  cursor:grab;
  display:flex; flex-direction:column; justify-content:flex-start; align-items:center;
  box-shadow:-3px 3px 6px rgba(0,0,0,.25), inset 0 0 30px rgba(255,255,255,.3);
  transition: left 0.5s ease, top 0.5s ease, transform 0.3s ease, box-shadow .15s;
  touch-action:none;
}
.note:active{cursor:grabbing;}
.note:hover{ box-shadow:-4px 4px 8px rgba(0,0,0,.35); }
body.dragging{ user-select:none; }

/* Angolo sollevato */
.note::after{
  content:""; position:absolute; right:0; bottom:0; width:40px; height:40px;
  background:linear-gradient(135deg, rgba(0,0,0,.25), transparent 70%);
  clip-path:polygon(100% 0, 0 100%, 100% 100%); pointer-events:none;
}

/* contenuti */
.note .text{
  font-size:13px; font-weight:bold; line-height:1.3; text-align:center; word-wrap:break-word;
  margin-top:14px;
}
.note small{ font-size:10px; color:#444; margin-top:5px; }

/* (RIMOSSA) icona elimina */

/* Pin rosso */
.note::before{
  content:""; width:12px; height:12px;
  background:radial-gradient(circle at 30% 30%, #ff5252, #c62828);
  border-radius:50%; position:absolute; top:6px; left:calc(50% - 6px);
  box-shadow:0 2px 5px rgba(0,0,0,.3);
}

/* Colori classici */
.yellow{background:linear-gradient(135deg,#fff59d,#fdd835);}
.blue  {background:linear-gradient(135deg,#90caf9,#42a5f5);}
.green {background:linear-gradient(135deg,#a5d6a7,#66bb6a);}
.pink  {background:linear-gradient(135deg,#f48fb1,#ec407a);}
.orange{background:linear-gradient(135deg,#ffcc80,#fb8c00);}
.black {background:linear-gradient(135deg,#000,#333); color:#fff;}

/* Personalizzati solo da # */
.red    {background:linear-gradient(135deg,#ff8a80,#e53935); color:#fff;}
.lilla  {background:linear-gradient(135deg,#ce93d8,#8e24aa); color:#fff;}
.fucsia,.fuxsia {background:linear-gradient(135deg,#f06292,#ad1457); color:#fff;}

/* Ghost (trasparente) */
.ghost {
  background: rgba(255, 255, 255, 0.05);
  color: rgba(0,0,0,0.3);
  border: 1px dashed rgba(0,0,0,0.15);
  backdrop-filter: blur(2px);
  box-shadow: none;
}

/* Madama lampeggiante */
.madama {
  background:linear-gradient(135deg,#ff1744,#b71c1c);
  color:#fff;
  animation: lampeggio 0.8s infinite alternate;
}
@keyframes lampeggio {
  from { box-shadow:0 0 5px #ff1744, 0 0 10px #ff1744; }
  to   { box-shadow:0 0 20px #ff1744, 0 0 40px #ff1744; }
}

/* Zona busta */
#shareZone {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 80px;
  height: 60px;
  background: url('https://upload.wikimedia.org/wikipedia/commons/4/4e/Envelope_font_awesome.svg') no-repeat center/contain;
  opacity: 0.6;
  transition: transform 0.2s, opacity 0.2s;
  z-index: 2000;
}
#shareZone.active { opacity: 1; transform: scale(1.1); }

/* Contatore */
#counterBox {
  margin-top: 10px;
  font-size: 14px;
  color: #333;
  font-weight: bold;
}
</style>
</head>
<body>
  <div class="container">
    <h1>üìå Sbotto un Post-it</h1>

    <!-- Box introduttivo breve -->
    <div class="intro">
       ‚ö° Se pensi di muovere un post-it di nascosto‚Ä¶ buona fortuna üëÄ
       <span class="info-icon" onclick="toggleRegolamento()">‚ÑπÔ∏è</span>
    </div>

    <textarea id="noteInput" placeholder="Scrivi qui il tuo post-it (max 70 caratteri)..."></textarea>

    <div class="controls">
      <div>
        <label>Colore Post-it:</label>
        <select id="colorSelect">
          <option value="yellow">Giallo</option>
          <option value="blue">Blu</option>
          <option value="green">Verde</option>
          <option value="pink">Rosa</option>
          <option value="orange">Arancione</option>
        </select>
      </div>
      <div>
        <label>Colore Testo:</label>
        <select id="textColorSelect">
          <option value="#000000">Nero</option>
          <option value="#1e88e5">Blu</option>
          <option value="#d32f2f">Rosso</option>
          <option value="#388e3c">Verde</option>
          <option value="#8e24aa">Viola</option>
          <option value="#ffffff">Bianco</option>
        </select>
      </div>
    </div>
   
    <button onclick="aggiungiNota()">Pubblica Post-it</button>
    <div id="counterBox">üìù Totale post-it: 0</div>
    <div id="board"></div>
  </div>

  <!-- Busta di condivisione -->
  <div id="shareZone"></div>

  <!-- Overlay + Box regolamento -->
  <div id="overlay" onclick="toggleRegolamento()"></div>
  <div id="regolamentoBox">
    <div class="close" onclick="toggleRegolamento()">√ó</div>
    <h2>üëã Benvenuto su sbotto.io</h2>
    <p>Bacheca anonima di post-it collaborativi.<br>Sfogati o lancia idee in tempo reale.</p>
    <hr>
    <h2>‚ú® In Diretta</h2>
    <p>Ogni post-it che compare qui √® stato scritto da qualcuno, da qualche parte, nello stesso momento.</p>
    <hr>
    <h2>üìú Regole</h2>
    <ul>
      <li>‚úçÔ∏è Messaggi brevi (max 70 caratteri).</li>
      <li>üö´ No spam o insulti.</li>
      <li>üëª Alcuni post-it speciali non si cancellano.</li>
      <li>ü§ù Rispetta gli altri e divertiti.</li>
    </ul>
  </div>

  <!-- GUN + html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
  // ========= PERSISTENZA "PER SEMPRE" =========
  const gun = Gun({
    peers:[
      "https://gun.database.eco/gun",
      "https://peer.wallie.io/gun",
      "https://gun-altcoins.herokuapp.com/gun"
    ],
    // persistenza locale
    localStorage: true,
    radisk: true,
    uuid: () => Gun.text.random(16)
  });
  const notesDB = gun.get("p2p-postit");
  const counterDB = gun.get("p2p-postit-counter"); // contatore globale

  // store in RAM
  let store = {};
  let drag = null;
  let totalCounter = 0;

  // chiavi backup locale
  const LS_BACKUP_KEY = "p2p-postit-backup-v1";
  const LS_BACKUP_COUNTER_KEY = "p2p-postit-counter-backup-v1";

  // Toggle regolamento
  function toggleRegolamento(){
    const box = document.getElementById("regolamentoBox");
    const overlay = document.getElementById("overlay");
    if(box.style.display === "block"){
      box.style.display = "none"; overlay.style.display = "none";
    } else {
      box.style.display = "block"; overlay.style.display = "block";
    }
  }

  // Dragging
  function pointerMove(e){
    if(!drag) return;
    e.preventDefault();
    const board = document.getElementById("board");
    const b = board.getBoundingClientRect();
    const el = drag.el;
    let x = e.clientX - b.left - drag.offsetX;
    let y = e.clientY - b.top  - drag.offsetY;
    const maxX = board.clientWidth  - el.offsetWidth;
    const maxY = board.clientHeight - el.offsetHeight;
    x = Math.max(0, Math.min(x, maxX));
    y = Math.max(0, Math.min(y, maxY));
    el.style.left = x + "px";
    el.style.top  = y + "px";

    const shareZone = document.getElementById("shareZone").getBoundingClientRect();
    if(e.clientX > shareZone.left && e.clientX < shareZone.right &&
       e.clientY > shareZone.top && e.clientY < shareZone.bottom){
        document.getElementById("shareZone").classList.add("active");
        drag.overShare = true;
    } else {
        document.getElementById("shareZone").classList.remove("active");
        drag.overShare = false;
    }
  }

  function pointerUp(){
    if(!drag) return;
    const { id, el, overShare } = drag;
    if(overShare){ condividiNota(id); }
    else {
      const n = store[id];
      if(n){ n.x = parseInt(el.style.left)||0; n.y = parseInt(el.style.top)||0;
        notesDB.get(id).put({ x:n.x, y:n.y });
      }
    }
    el.style.transition = "left 0.5s ease, top 0.5s ease, transform 0.3s ease, box-shadow .15s";
    document.getElementById("shareZone").classList.remove("active");
    document.body.classList.remove("dragging");
    drag = null;
  }
  document.addEventListener("pointermove", pointerMove, {passive:false});
  document.addEventListener("pointerup", pointerUp);

  // Rendering
  function render(){
    const board = document.getElementById("board");
    board.innerHTML="";
    Object.values(store).forEach(n=>{
      if(!n) return;

      // **PER SEMPRE**: ignora eventuali flag di cancellazione remoti
      // if(n.deleted) return;  // <- NON lo facciamo pi√π

      const div = document.createElement("div");
      div.id = "note_"+n.id;
      div.className = `note ${n.color}`;
      div.style.color = n.textColor;
      div.style.left = (n.x||0) + "px";
      div.style.top  = (n.y||0) + "px";
      div.style.transform = `rotate(${n.rot}deg)`;

      // rimosso pulsante elimina per rendere i post-it permanenti
      div.innerHTML = `
        <div class="text">${n.text}</div>
        <small>${new Date(n.date).toLocaleString()}</small>
      `;

      div.addEventListener("pointerdown",(e)=>{
        const elRect = div.getBoundingClientRect();
        drag = { id: n.id, el: div,
          offsetX: e.clientX - elRect.left,
          offsetY: e.clientY - elRect.top };
        div.style.transition = "none";
        div.style.zIndex = 9999;
        document.body.classList.add("dragging");
        if(div.setPointerCapture) { try{ div.setPointerCapture(e.pointerId);}catch(_){ } }
        e.preventDefault();
      });
      board.appendChild(div);
    });
  }

  // Comandi speciali
  function parseSpecial(input){
    const m = input.match(/^\s*#([a-z√†√®√©√¨√≤√≥√π]+)\b/i);
    if(!m) return null;
    const tag = m[1].toLowerCase();
    const rest = input.replace(/^\s*#[^\s]+\s*/,'').trim();

    if(tag === 'mod')    return { color:'black',  textColor:'#fff', text:rest };
    if(tag === 'ghost')  return { color:'ghost',  textColor:'rgba(0,0,0,0.3)', text:rest };
    if(tag === 'madama') return { color:'madama', textColor:'#fff', text:rest };
    if(tag === 'red' || tag === 'rosso')   return { color:'red',   textColor:'#fff', text:rest };
    if(tag === 'lilla')  return { color:'lilla',  textColor:'#fff', text:rest };
    if(tag === 'fucsia' || tag === 'fuxsia') return { color:'fucsia', textColor:'#fff', text:rest };
    return null;
  }

  // Aggiungi nota (limite 70 caratteri)
  function aggiungiNota(){
    let text = document.getElementById("noteInput").value.trim();
    if(!text) return alert("Scrivi qualcosa!");
    if(text.length > 70) text = text.substring(0,67)+"...";

    const board = document.getElementById("board");
    const maxX = Math.max(0, board.clientWidth-150);
    const maxY = Math.max(0, board.clientHeight-150);

    let note = {
      id: Gun.text.random(16),
      text, date: Date.now(),
      x: Math.floor(Math.random()*maxX),
      y: Math.floor(Math.random()*maxY),
      rot: (Math.random()*10 - 5).toFixed(2)
    };

    const special = parseSpecial(text);
    if(special){ Object.assign(note, special); }
    else {
      note.color = document.getElementById("colorSelect").value;
      note.textColor = document.getElementById("textColorSelect").value;
    }

    // scrivi su GUN
    notesDB.get(note.id).put(note);

    // incrementa contatore globale (senza decrementi)
    counterDB.get("total").once(val=>{
      const current = (typeof val === 'number' ? val : 0);
      counterDB.get("total").put(current + 1);
      // aggiorna backup subito
      try { localStorage.setItem(LS_BACKUP_COUNTER_KEY, String(current + 1)); } catch(e){}
    });

    // backup veloce locale
    try {
      const snapshot = JSON.parse(localStorage.getItem(LS_BACKUP_KEY) || "[]");
      snapshot.push(note);
      // per 5000 note: rimaniamo entro limiti; se supera quota, il catch evita errori
      localStorage.setItem(LS_BACKUP_KEY, JSON.stringify(snapshot));
    } catch(e){ /* quota piena, ignoriamo: Radisk mantiene comunque */ }

    document.getElementById("noteInput").value="";
  }

  // (RIMOSSA) Elimina nota: disabilitata per "per sempre"
  // function eliminaNota(id){}

  // Condividi nota
  function condividiNota(id){
    const div = document.getElementById("note_"+id);
    if(!div) return;
    html2canvas(div).then(canvas=>{
      canvas.toBlob(blob=>{
        const file = new File([blob], "postit.png", {type:"image/png"});
        if(navigator.canShare && navigator.canShare({files:[file]})){
          navigator.share({title:"Post-it",text:"üìå Guarda questo post-it:",files:[file]}).catch(()=>{});
        } else {
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "postit.png";
          link.click();
        }
      });
    });
  }

  // ======== CARICAMENTO INIZIALE PERSISTENTE ========
  let initialLoadDone = false;

  // 1) Recupera TUTTE le note gi√† salvate una volta (persistenza)
  notesDB.map().once((n,id)=>{
    if(n && n.id){
      // Ignora cancellazioni remote
      if(n.deleted) { n.deleted = false; }
      store[id]=Object.assign(store[id]||{}, n);
    }
  });

  // 2) Ascolta cambi live
  notesDB.map().on((n,id)=>{
    if(n && n.id){
      if(n.deleted){ /* ignoriamo */ return; }
      store[id]=Object.assign(store[id]||{}, n);
    }
    render();
  });

  // 3) Fallback: se entro 2s non abbiamo niente, ripristina da backup locale
  setTimeout(()=>{
    if(Object.keys(store).length === 0){
      try{
        const backup = JSON.parse(localStorage.getItem(LS_BACKUP_KEY) || "[]");
        if(Array.isArray(backup) && backup.length){
          backup.forEach(n => {
            store[n.id] = n;
            // rimettiamo anche su GUN se mancasse
            notesDB.get(n.id).put(n);
          });
        }
      }catch(e){}
      render();
    }
    initialLoadDone = true;
  }, 2000);

  // Contatore globale (con backup)
  counterDB.get("total").on(val=>{
    totalCounter = (typeof val === 'number' ? val : 0);
    if(!val){
      // prova ripristino da backup locale
      const b = parseInt(localStorage.getItem(LS_BACKUP_COUNTER_KEY)||"0",10);
      if(b>0){ totalCounter=b; counterDB.get("total").put(b); }
    }
    document.getElementById("counterBox").textContent = "üìù Totale post-it: " + totalCounter;
  });

  // Backup periodico locale (ogni 60s)
  setInterval(()=>{
    try {
      const arr = Object.values(store);
      localStorage.setItem(LS_BACKUP_KEY, JSON.stringify(arr));
      localStorage.setItem(LS_BACKUP_COUNTER_KEY, String(totalCounter||0));
    } catch(e){ /* ignoriamo quote error */ }
  }, 60000);

  // Backup alla chiusura pagina
  window.addEventListener('beforeunload', ()=>{
    try {
      const arr = Object.values(store);
      localStorage.setItem(LS_BACKUP_KEY, JSON.stringify(arr));
      localStorage.setItem(LS_BACKUP_COUNTER_KEY, String(totalCounter||0));
    } catch(e){}
  });

  </script>
</body>
</html>
